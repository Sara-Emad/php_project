<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/style/createorder.css">
</head>
<body>
  <div class="search-container">
      <input 
        type="text" 
        id="productSearch" 
        class="search-input" 
        placeholder="Search for products..."
      >
  </div>
    
  <div id="productGrid" class="product-grid">
    <!-- Products will be displayed here -->
  </div>
  <div id="orderItemsInputs" style="display: none;">
      <!-- Hidden inputs will be added here -->
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>

let allProducts = [];

document.addEventListener("DOMContentLoaded", function () {
    // Get products from the select element and store them
    const productSelect = document.querySelector('select[name="product_id"]');
    if (productSelect) {
        allProducts = Array.from(productSelect.options)
            .filter(option => option.value) // Skip the "Select Product" option
            .map(option => {
                const [name, priceText] = option.text.split(' - EGP ');
                return {
                    id: option.value,
                    name: name.trim(),
                    price: parseFloat(priceText),
                    category: option.dataset.category || '',
                    image: option.dataset.image || ''
                };
            });
    }

    // Set up search input handler with debouncing
    const searchInput = document.getElementById('productSearch');
    let debounceTimeout;

    if (searchInput) {
        searchInput.addEventListener('input', function (e) {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                const searchTerm = e.target.value.toLowerCase().trim();
                filterAndDisplayProducts(searchTerm);
            }, 300);
        });

        // Initial display of all products
        filterAndDisplayProducts('');
    }
});

// Enhanced filter function with multiple search criteria
function filterAndDisplayProducts(searchTerm) {
    const filteredProducts = allProducts.filter(product => {
        if (!searchTerm) return true;
        
        // Search in product name
        if (product.name.toLowerCase().includes(searchTerm)) return true;
        
        // Search in price (if searchTerm is a number)
        const searchNumber = parseFloat(searchTerm);
        if (!isNaN(searchNumber) && product.price === searchNumber) return true;
        
        // Search in category
        if (product.category.toLowerCase().includes(searchTerm)) return true;
        
        return false;
    });

    displayProducts(filteredProducts);
}

// Enhanced display function with proper image handling
function displayProducts(products) {
    const productGrid = document.getElementById('productGrid');
    
    if (!productGrid) {
        console.error("Product grid element not found");
        return;
    }
    
    if (products.length === 0) {
        productGrid.innerHTML = `
            <div class="no-results">
                <div class="text-center text-gray-500 my-8">
                    <i class="fas fa-search mb-3"></i>
                    <p>No products found</p>
                </div>
            </div>`;
        return;
    }
    
    productGrid.innerHTML = products.map(product => {
        // Construct proper image path
        const imagePath = product.image 
            ? `./uploads/products/${product.image}`
            : './assets/images/default-product.jpg';
            
        return `
            <div class="product-card" data-product-id="${product.id}">
                <img src="${imagePath}" 
                    alt="${escapeHtml(product.name)}"
                    onerror="this.src='./assets/images/default-product.jpg'"
                    class="product-image">
                <div class="product-info">
                    <div class="product-name">${escapeHtml(product.name)}</div>
                    <div class="product-price">EGP ${product.price.toFixed(2)}</div>
                    <button class="add-to-cart" onclick="quickAddToOrder(${product.id}, '${escapeHtml(product.name).replace(/'/g, "\\'").replace(/"/g, '\\"')}', ${product.price})">
                        Add to Order
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// Utility function to escape HTML and prevent XSS
function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

</script>
</body>
</html>